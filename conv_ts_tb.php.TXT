<?php
/**
 * TrackBack データ変換スクリプト
 *
 * @copyright   Copyright &copy; 2005, Katsumi Saito <katsumi@jo1upk.ymt.prug.or.jp>
 * @version     $Id: conv_ts_tb.php,v 0.2 2005/06/05 03:04:00 upk Exp $
 *
 */

define('DATA_HOME', '');
define('TRACKBACK_DIR', DATA_HOME . 'trackback/');

define('LOCALZONE', date('Z'));

echo "<pre>\n";
get_tracback_data(TRACKBACK_DIR);
echo "</pre>\n";

function get_tracback_data($x)
{
	global $ctr_all, $ctr_ok, $ctr_err;

	$ctr_all = $ctr_ok = $ctr_err = 0;

	if (!($dir = @opendir($x))) return '';
	while($file = readdir($dir))
	{
		if($file == '..' || $file == '.') continue;
		if (strstr($file,".txt") != TRUE) continue;
		$ctr_all++;
		trackback_data_update($x.$file);
	}
	closedir($dir);
	if ($ctr_err == 0) {
		echo "== ALL PROCESSING WAS COMPLETED. ==\n";
	}
	echo "$ctr_all files, $ctr_ok changed[O], $ctr_err errores[E].\n";
	return '';
}

function trackback_data_update($x)
{
	global $ctr_all, $ctr_ok, $ctr_err;
	$data = tb_get2($x);
	$update = '';
	foreach($data as $_data) {
		$ts = substr($_data,0,10);
		$body = substr($_data,10);
		$time = $ts + LOCALZONE;
		$update .= $time . $body;
	}
	if (tb_put2($x,$update)) {
		echo "[O]$x\n";
		$ctr_ok++;
	} else {
		echo "[E]$x\n";
		$ctr_err++;
	}
}

function tb_get2($file)
{
        if (! file_exists($file)) return array();

        $result = array();
        $fp = @fopen($file, 'r');
        set_file_buffer($fp, 0);
        flock($fp, LOCK_EX);
        rewind($fp);
	while ($data = @fgets($fp, 8192)) {
		$result[] = $data;
	}
        flock($fp, LOCK_UN);
        fclose ($fp);

        return $result;
}

function tb_put2($file,$data)
{
	$mtime = filemtime($file);
	if (!($fp = fopen($file,'w'))) return FALSE;
	@flock($fp, LOCK_EX);
	fwrite($fp, $data);
	@flock($fp, LOCK_UN);
	@fclose($fp);
	@touch($file, $mtime);
	return TRUE;
}

?>
